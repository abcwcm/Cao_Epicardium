---
title: "Processing"
author: "Friederike DÃ¼ndar"
date: "8/30/2019; updated `r Sys.Date()`"
output:
    html_document:
        toc: true
        toc_depth: 6
        code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE, cache.lazy = FALSE, warning = FALSE, eval=FALSE)
```

TO DO: check how this was done for all cells (the code below is currently for dpa7 only!)

## Tcf21-high cells

We removed cells assigned to clusters 6, 8, 10, 11 and re-processed the remaining cells.
For details of the processing: `2019-07-23_ExlcudingNonEpiClusters.Rmd`


* extracted *Tcf21*-high cells (= mostly epicardial cells)
* re-did `scTransform` calculation, PCA, UMAP, clustering (`Seurat`)
* calculated diffusion map coordinates (`destiny`)

```{r processing_d7_only, eval=FALSE}
setwd("/scratchLocal/frd2007/2019_06_Jingli/2019-08_7dpa_only")
scf <- readRDS(file = "/scratchLocal/frd2007/2019_06_Jingli/data/sce_CellGeneFiltWithScTransformBatchCorrect_ClustRemoved_2019-07.rds")
scf <- scf[, scf$condition == "7dpa"]
scf <- calculateQCMetrics(scf)
> dim(scf)
#[1] 17443  6055

keep_genes <- rowData(scf)$n_cells_by_counts >= 5
scf <- scf[keep_genes,]
dim(scf)
#[1] 16327  6055

## re-do clustering ===========================================
library(Seurat)
srt <- CreateSeuratObject(counts = counts(scf), 
                          project = "7dpa", assay = "RNA",
                          min.cells = 0, min.features = 0,
                          names.field = 1, 
                          meta.data = as.data.frame(colData(scf)[, c("Sample","condition")])
                          )

srt <- SCTransform(srt, new.assay.name = "scTrans.7dpa")

srt <- RunPCA(object = srt, features = VariableFeatures(object = srt), do.print = FALSE)
png("elbow_plot_d7_scTransform.png")
ElbowPlot(object = srt) # -->  to determine the # of dims for tSNE
dev.off()

png("pca_dimLoadings_d7_scTransform.png", height = 1900, width = 1500)
VizDimLoadings(srt, dims = 1:20, reduction = "pca")
dev.off()
Loadings(srt) %>% as.data.frame %>% saveRDS("loadings_seurat_d7.rds")

png("pca_dimPlot_d7_scTransform.png", height = 1500, width = 1500)
DimPlot(srt, reduction = "pca",  group.by = "orig.ident")
dev.off()

png("pca_dimHeatmaps_d7_scTransform.png", height = 1500, width = 800)
DimHeatmap(srt, dims = 1:20,  balanced = TRUE) #equal number of genes with both + and - scores
dev.off()

srt <- RunUMAP(object = srt, 
               reduction = "pca",
               dims = 1:20,# check the elbow plot
               n.neighbors = 30L,
               metric = "correlation")

srt <- FindNeighbors(srt, dims = 1:20) #construct a KNN graph based on the euclidean distance in PCA space, and refine the edge weights between any two cells based on the shared overlap in their local neighborhoods (Jaccard similarity)
srt <- FindClusters(srt, resolution = .8) #Louvain algorithm 
markers_srt.08 <- FindAllMarkers(srt)

srt <- FindClusters(srt, resolution = .3) #Louvain algorithm 
markers_srt.03 <- FindAllMarkers(srt)

saveRDS(srt, file = "seurat_d7_scTransform.rds")
saveRDS(markers_srt.03, file = "markers_seurat_d7_res03.rds")
saveRDS(markers_srt.08, file = "markers_seurat_d7_res08.rds")

## bringing data back into SCE
cd_srt <-  srt@meta.data
scf$clusters_d7.03 <- cd_srt[colnames(scf),]$scTrans.7dpa_snn_res.0.3
scf$clusters_d7.08 <- cd_srt[colnames(scf),]$scTrans.7dpa_snn_res.0.8

### reduced dimensions
reducedDim(scf, "pca_d7") <- Embeddings(object = srt, reduction = "pca")[colnames(scf),]
reducedDim(scf, "umap_d7") <- Embeddings(object = srt, reduction = "umap")[colnames(scf),]

### normalized data
rnms <- data.table(ori = row.names(scf)) # get original rownames -- Seurat replaces underscores with hyphens...
rnms[,seurat := gsub("_","-", ori)]

## the default setting of sctransform::vst is to remove genes expressed in fewer than 5 cells,
## therefore I need to adjust the data set
normd <- as.data.table(as.matrix(GetAssayData(object = srt)), keep.rownames = TRUE) # log1p(corrected counts, i.e. Pearson residuals)
setnames(normd, "rn", "seurat")
normd <- rnms[normd, on = "seurat"]
dim(scf)
#[1] 16327  6055

scf <- scf[normd$ori, ] ## filtering!
dim(scf)
#[1] 16327  6055

normd.m <- as.matrix(normd[, -c("seurat", "ori"), with=FALSE])
rownames(normd.m) <- normd$ori
normd.m <- normd.m[rownames(scf), colnames(scf)]
assay(scf, "log1p_sctransform") <- normd.m

##!saveRDS(scf, file = "sce_7dpa_ScTransform_ClustRemoved_2019-07.rds")

## DIFFUSION MAP=============
dat_exprs <- scater:::.get_mat_for_reddim(scf, exprs_values = "log1p_sctransform",
                                          ntop = 1000, scale=TRUE)
## DIFFUSION MAP
dat_exprs <- as.matrix(dat_exprs)
set.seed(345)
diffmap <- destiny::DiffusionMap(dat_exprs, distance = 'e')
tip_cell <- destiny::find_tips(diffmap)
diffpseudotime <- destiny::DPT(diffmap, tips = tip_cell)

save(diffmap, tip_cell, diffpseudotime, file = "destiny_d7.rda")

## add to SCE object
reducedDim(scf, "diffusionMap.7dOnly") <- diffmap@eigenvectors
colData(scf)$dpt1.7d <- diffpseudotime[tip_cell, ][1,]
colData(scf)$dpt2.7d <- diffpseudotime[tip_cell, ][2,]
colData(scf)$dpt3.7d <- diffpseudotime[tip_cell, ][3,]

##!saveRDS(scf, file = "sce_7dpa_ScTransform_ClustRemoved_2019-07.rds")
```
